---
title: "ETC2420 Group 53"
authors: "Sineth Wickramsinghe, Janiru Rathnapriya, Senuth Dias, Lawrence"
output: html_document
date: "2024-09-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE, error = FALSE)
library(tidyverse)
library(broom)
library(gridExtra)
library(MASS)

# Creates a histogram and smoothed histogram given a vector of values.
dataplot <- function(x, bins = 50, colour = "blue") {
  ggplot(tibble(x = x), aes(x = x, y = after_stat(density))) +
    geom_histogram(bins = bins, colour = colour, fill = colour, alpha = 0.2) +
    geom_density(colour = colour, fill = colour, alpha = 0.2) +
    theme_bw()
}

set.seed(24205242)
```

```{r Reading Bank Survey Data}
bank <- read_csv("banksurvey.csv")
head(bank)
```

# **Task #1**

### Descriptive Statistics on Customer Income

```{r Descriptive Statistics}

summary(bank$income) #Provides descriptive stats of customer income 
sd(bank$income) #Standard deviation of customer income 

income_summary <- 
  bank %>% 
  summarise(
    mean = mean(income), 
    median = median(income), 
    sd = sd(income), 
    max = max(income), 
    min = min(income)
  )
income_summary
```
### Visualising the Customer Income ($) Data 

```{r Visualising Data}
dataplot(bank$income) + 
  geom_vline(xintercept = income_summary$mean, colour = "red", linetype = 5) +
  geom_vline(xintercept = income_summary$median, colour = "blue", linetype = 2) +
  annotate("text", label = "mean", x = income_summary$mean + 20, y = 0.011) +
  annotate("text", label = "median", x = income_summary$median - 25, y = 0.011) +
  xlab("Customer Income ($)") + 
  ylab("Frequency") + 
  ggtitle("Distribution of Customer Income ($)") + 
  theme(plot.title = element_text(hjust = 0.5))
```


### Fitting Customer Income to Various Models

```{r Fitting Customer Income to Varuous Models}
normal_fit <- fitdistr(bank$income, "normal")
normal_fit %>% tidy()

exponential_fit <- fitdistr(bank$income, "exponential") 
exponential_fit %>% tidy()

gamma_fit <- fitdistr(bank$income, "gamma") 
gamma_fit %>% tidy()
```

### Normal Distribution QQ Plot Customer Income ($) 

```{r}
qq_norm <- 
  bank %>% 
  ggplot() +
    aes(sample = income) +
    stat_qq(distribution = qnorm, dparams = normal_fit$estimate) +
    stat_qq_line(distribution = qnorm, dparams = normal_fit$estimate, color = "red") +
    theme(aspect.ratio = 1) +    
    theme_bw() +
    xlab("Theoretical quantiles (normal distribution)") +
    ylab("Sample (income)")
qq_norm
```

### Exponential Distribution QQ Plot Customer Income ($) 


```{r}
qq_exp <- 
  bank %>% 
  ggplot() +
    aes(sample = income) +
    stat_qq(distribution = qexp, dparams = exponential_fit$estimate) +
    stat_qq_line(distribution = qexp, dparams = exponential_fit$estimate, color = "red") +
    theme(aspect.ratio = 1) +    
    theme_bw() +
    xlab("Theoretical quantiles (exponential distribution)") +
    ylab("Sample (income)")
qq_exp
```



### Gamma Distribution QQ Plot Customer Income ($) 


```{r}
qq_gamma <- 
  bank %>% 
  ggplot() +
    aes(sample = income) +
    stat_qq(distribution = qgamma, dparams = gamma_fit$estimate) +
    stat_qq_line(distribution = qgamma, dparams = gamma_fit$estimate, color = "red") +
    theme(aspect.ratio = 1) +    
    theme_bw() +
    xlab("Theoretical quantiles (gamma distribution)") +
    ylab("Sample (income)")
qq_gamma
```



## **Task 2**

### Estimating 80th Percentile of Customer Income ($) using quantile() R function 

```{r}
normal_80th_percentile <- qnorm(0.8, mean = normal_fit$estimate[1], sd =normal_fit$estimate[2])
exponential_80th_percentile <- qexp(0.8, rate = exponential_fit$estimate)
gamma_80th_percentile <- qgamma(0.8, shape = gamma_fit$estimate[1], rate = gamma_fit$estimate[2])
sample_80th_percentile <- quantile(bank$income, probs = 0.8, type = 7)

tibble(normal_80th_percentile, exponential_80th_percentile, gamma_80th_percentile, sample_80th_percentile)
```




```{r}
B <- 5000
norm_quant <- matrix(nrow = B, ncol = 1)

for (b in 1:B) {
  temp <- sample(bank$income, replace = TRUE)
  fit <- fitdistr(temp, "normal")
  
  norm_quant[b,] <- qnorm(0.8, fit$estimate[1], fit$estimate[2])
}

normal_80th_percentiles <- quantile(norm_quant, c(0.025, 0.975))

normal_80th_percentiles
```


```{r}
B <- 5000
exp_quant <- matrix(nrow = B, ncol = 1)

for (b in 1:B) {
  temp <- sample(bank$income, replace = TRUE)
  fit <- fitdistr(temp, "exponential")
  
  exp_quant[b,] <- qexp(0.8, fit$estimate)
}

exponential_80th_percentiles <- quantile(exp_quant, c(0.025, 0.975))
exponential_80th_percentiles 
```

```{r}
B <- 5000
gamma_quant <- matrix(nrow = B, ncol = 1)

for (b in 1:B) {
  temp <- sample(bank$income, replace = TRUE)
  fit <- fitdistr(temp, "gamma")
  
  gamma_quant[b,] <- qgamma(0.8, fit$estimate[1], fit$estimate[2])
}

gamma_80th_percentiles <- quantile(gamma_quant, c(0.025, 0.975))
gamma_80th_percentiles
```

```{r}
B <- 5000
quant <- matrix(nrow = B, ncol = 1)

for (b in 1:B) {
  temp <- sample(bank$income, replace = TRUE)
  quant[b,] <- quantile(temp, probs = 0.8, type = 7)
}

sample_80th_percentiles <- quantile(quant, c(0.025, 0.975))
```

```{r}
data.frame(Normal_80th_percentiles = normal_80th_percentiles,
           Exponential_80th_percentiles = exponential_80th_percentiles,
           Gamma_80th_percentiles = gamma_80th_percentiles,
           Sample_80th_percentiles = sample_80th_percentiles,
           row.names = c("Lower",
                         "Upper")
           )
```

## **Task 3**

```{r}
n <- 200
B <- 5000

samples <- replicate(B, rexp(n, rate = 1/100))

for (i in 5000) {
  sample <- rexp(200, 1/100)
  
}

normal_estimates <- apply(samples, 2, function(x) qnorm(0.8, mean(x), sd(x)))
exp_estimates <- apply(samples, 2, function(x) qexp(0.8, rate = 1/mean(x)))
gamma_estimates <- apply(samples, 2, function(x) {
  fit <- fitdistr(x, "gamma")
  qgamma(0.8, shape = fit$estimate["shape"], rate = fit$estimate["rate"])
})

true_80th_percentile <- qexp(0.8, 1/100)
all_80th_percentile_estimates <- tibble(normal_estimates, exp_estimates, gamma_estimates) 
```

```{r}
all_80th_percentile_estimates %>%
  gather(key = "Estimator", value = "Estimate") %>%
  ggplot(aes(x = Estimate, fill = Estimator)) +
  geom_density(alpha = 0.3) +
  geom_vline(xintercept = true_80th_percentile, color = "red", linetype = "dashed") +
  labs(title = "Sampling Distributions of the 80th Percentile Estimator",
       x = "Estimated 80th Percentile", y = "Density") +
  theme_minimal()
```
```{r}
bias_normal <- mean(normal_estimates) - true_80th_percentile
bias_exp <- mean(exp_estimates) - true_80th_percentile
bias_gamma <- mean(gamma_estimates) - true_80th_percentile

bias = c(bias_normal, bias_exp, bias_gamma)

sd_normal <- sd(normal_estimates)
sd_exp <- sd(exp_estimates)
sd_gamma <- sd(gamma_estimates)

sd = c(sd_normal, sd_exp, sd_gamma)

data.frame(Bias = bias,
           Standard_Deviation = sd,
           row.names = c("Normal",
                         "Exponential",
                         "Gamma"))
```


## **Task 4**

```{r}
unique(bank$education) 

master <- bank %>% filter(education == "Master") 
bachelor <- bank %>% filter(education == "Bachelor") 
highschool <- bank %>% filter(education == "High school") 
doctorate <- bank %>% filter(education == "Doctorate") 

master_plot <- dataplot(master$income, bins = 30) + ggtitle("Masters")  + xlab("Income ($)")
bachelor_plot <- dataplot(bachelor$income, bins = 30) + ggtitle("Bachelor") + xlab("Income ($)")
highschool_plot <- dataplot(highschool$income, bins = 30) + ggtitle("High School") + xlab("Income ($)")
doctorate_plot <- dataplot(doctorate$income, bins = 30) + ggtitle("Doctorate") + xlab("Income ($)")

grid.arrange(master_plot, bachelor_plot, highschool_plot, doctorate_plot)
```

```{r}
n_completed_uni <- bank %>% filter(education == "High school")
mean(n_completed_uni$income)

completed_uni <- bank %>% filter(education != "High school")
mean(completed_uni$income) 

t_test_result <- t.test(completed_uni$income, n_completed_uni$income, conf.level = 0.95)

t_test_result$conf.int
```

## **Task 5**
```{r}
dataplot(n_completed_uni$income)
dataplot(completed_uni$income)

gamma_exponential <- function(n, xbar, alpha = 1, beta = 1) {
  atil <- alpha + n
  btil <- beta + n*xbar
  out <- list(alpha_tilde = atil, beta_tilde = btil)
  return(out)
}

gamma_meanvar <- function(alpha, beta) {
  mean <- alpha / beta
  var <- alpha / (beta^2)
  out <- list(mean = mean, var = var)
  return(out)
}

n_completed_uni_posterior <- gamma_exponential(30, 65.06)
completed_uni_posterior <- gamma_exponential(170, 93.48941)
n_completed_uni_posterior #distribution of 位_0
completed_uni_posterior #distribution of 位_1

qgamma(c(0.025, 0.975), n_completed_uni_posterior$alpha_tilde, n_completed_uni_posterior$beta_tilde) #95% chance of 位_0 being within this interval
qgamma(c(0.025, 0.975), completed_uni_posterior$alpha_tilde, completed_uni_posterior$beta_tilde) #95% chance of 位_1 being within this interval
```

```{r}
R <- 10000

sampleCompleted <- rgamma(R, completed_uni_posterior$alpha_tilde, completed_uni_posterior$beta_tilde)
sampleHighschool <- rgamma(R, n_completed_uni_posterior$alpha_tilde, n_completed_uni_posterior$beta_tilde)
sampleDifference <- sampleCompleted - sampleHighschool

blob <- qexp(0.8, sampleCompleted) - qexp(0.8, sampleHighschool)

quantile(blob, probs = c(0.025,0.975), type = 7)
```

